#!/usr/bin/env bash

set -euxo pipefail

echo "Configuring Eirini"

export KUBECONFIG="/var/vcap/jobs/opi/config/kube.conf"
kubectl="/var/vcap/packages/kubectl/bin/kubectl"

$kubectl apply -f <($kubectl create secret generic loggregator-tls-certs-secret \
  --dry-run \
  --save-config \
  --from-file=internal-ca-cert=/var/vcap/jobs/configure-eirini/config/loggregator-ca.crt \
  --from-file=loggregator-agent-cert=/var/vcap/jobs/configure-eirini/config/loggregator-agent.crt \
  --from-file=loggregator-agent-cert-key=/var/vcap/jobs/configure-eirini/config/loggregator-agent.key \
  -o yaml)

echo "Setting up fluentd configuration"
$kubectl apply -f /var/vcap/jobs/configure-eirini/config/fluentd-configmap.yaml

echo "Setting up Eirini daemonsets"
$kubectl apply -f /var/vcap/jobs/configure-eirini/config/eirini-daemonset.yaml
